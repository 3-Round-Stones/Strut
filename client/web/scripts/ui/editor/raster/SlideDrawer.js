// Generated by CoffeeScript 1.2.1-pre
/*
@author Matt Crinklaw-Vogt
*/

define(["common/Throttler"], function(Throttler) {
  var SlideDrawer;
  return SlideDrawer = (function() {

    SlideDrawer.name = 'SlideDrawer';

    function SlideDrawer(model, g2d) {
      this.model = model;
      this.g2d = g2d;
      this.model.on("contentsChanged", this.repaint, this);
      this.size = {
        width: this.g2d.canvas.width,
        height: this.g2d.canvas.height
      };
      this.throttler = new Throttler(600, this);
      this.scale = this.size.width / slideConfig.size.width;
    }

    SlideDrawer.prototype.resized = function(newSize) {
      this.size = newSize;
      this.scale = this.size.width / slideConfig.size.width;
      return this.repaint();
    };

    SlideDrawer.prototype.repaint = function() {
      return this.throttler.submit(this.paint, {
        rejectionPolicy: "runLast"
      });
    };

    SlideDrawer.prototype.paint = function() {
      var components,
        _this = this;
      this.g2d.clearRect(0, 0, this.size.width, this.size.height);
      components = this.model.get("components");
      return components.forEach(function(component) {
        var type;
        type = component.constructor.name;
        _this.g2d.save();
        /*
        				# TODO: figure out correct translation to apply after transforms
        				skewX = component.get("skewX")
        				skewY = component.get("skewY")
        				transform = [1,0,0,1,0,0]
        				if skewX
        					transform[1] = skewX
        				if skewY
        					transform[2] = skewY
        				@g2d.transform.apply(@g2d, transform)
        
        				rotate = component.get("rotate")
        				if rotate
        					@g2d.rotate(rotate)
        */

        switch (type) {
          case "TextBox":
            _this.paintTextBox(component);
            break;
          case "ImageModel":
            _this.paintImage(component);
            break;
          case "Table":
            _this.paintTable(component);
        }
        return _this.g2d.restore();
      });
    };

    SlideDrawer.prototype.paintTextBox = function(textBox) {
      this.g2d.fillStyle = "#" + textBox.get("color");
      this.g2d.font = textBox.get("size") * this.scale + "px " + textBox.get("family");
      return this.g2d.fillText(textBox.get("text"), textBox.get("x") * this.scale, textBox.get("y") * this.scale + textBox.get("size") * this.scale);
    };

    SlideDrawer.prototype.paintImage = function(imageModel) {
      var image,
        _this = this;
      image = new Image();
      image.onload = function() {
        return _this.g2d.drawImage(image, imageModel.get("x") * _this.scale, imageModel.get("y") * _this.scale, image.naturalWidth * _this.scale, image.naturalHeight * _this.scale);
      };
      return image.src = imageModel.get("src");
    };

    SlideDrawer.prototype.paintTable = function() {};

    SlideDrawer.prototype.dispose = function() {
      return this.model.off(null, null, this);
    };

    return SlideDrawer;

  })();
});
